---
name: Sync Issues

on:
  push:
    branches: [main]
    paths:
      - '.github/issues/**'
      - '.github/src/**'
      - '.github/actions/**'
      - '.github/workflows/sync-issues.yml'
      - '**/*.py'
      - '**/*.js'
      - '**/*.jsx'
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.md'
      - '**/*.yml'
      - '**/*.yaml'
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

concurrency:
  group: ${{ github.event_name == 'pull_request' && format('sync-issues-pr-{0}', github.event.pull_request.number) || format('sync-issues-main-{0}', github.sha) }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  test:
    name: Test Action Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Enable Corepack
        run: corepack enable
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
      
      - name: Install dependencies
        run: yarn install
      
      - name: Run tests
        run: |
          cd .github
          yarn test
      
      - name: Check coverage
        run: |
          cd .github
          yarn test:coverage

  scan-todos:
    name: Scan TODOs in Code
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Scan and sync TODOs
        uses: ./.github/actions/persist-github-issues-to-files
        with:
          mode: 'scan-todos'
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Push changes if any
        run: |
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git push
            echo "✅ Pushed TODO doc updates to PR branch"
          fi
      
      - name: Summary
        run: |
          {
            echo "✅ TODO scan complete"
            echo ""
            echo "TODOs in code have been synced to \`.github/issues/\` docs"
            echo ""
            echo "When this PR is merged to main, docs without issue numbers will automatically get GitHub issues created."
          } >> $GITHUB_STEP_SUMMARY
  
  sync:
    name: Sync Issues with Docs
    runs-on: ubuntu-latest
    if: "github.event_name != 'pull_request' && !contains(github.event.head_commit.message, '[skip ci]')"
    needs: [test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create labels if missing
        uses: crazy-max/ghaction-github-labeler@v5
        with:
          github-token: ${{ github.token }}

      - name: Get changed files
        id: changed-files
        if: github.event_name == 'push'
        run: |
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep '^\.github/issues/' || true)
          else
            CHANGED=$(git ls-files .github/issues/)
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Handle issue event (created/edited)
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Install dependencies for TypeScript
          npm install --include=dev
          
          # Use Node script to handle issue events
          node << 'SCRIPT'
          const { execSync } = require('child_process');
          const fs = require('fs');
          const path = require('path');
          const yaml = require('js-yaml');
          
          const eventType = process.env.GITHUB_EVENT_PATH ? 
            JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8')).action : 
            'opened';
          const issue = process.env.GITHUB_EVENT_PATH ?
            JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8')).issue :
            null;
          
          if (!issue) {
            console.log('No issue data found');
            process.exit(0);
          }
          
          const issueNumber = issue.number;
          const issueTitle = issue.title;
          const issueBody = issue.body || '';
          
          // Get labels and assignees
          const result = execSync(`gh issue view ${issueNumber} --json labels,assignees`, { encoding: 'utf8' });
          const issueData = JSON.parse(result);
          const labels = issueData.labels.map(l => l.name);
          const assignees = issueData.assignees.map(a => a.login);
          
          const issuesDir = '.github/issues';
          const existingFiles = fs.readdirSync(issuesDir).filter(f => f.startsWith(`${issueNumber}-`));
          
          if (eventType === 'opened' && existingFiles.length === 0) {
            // Create new doc
            const slug = issueTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const filename = `${issueNumber}-${slug}.md`;
            const filepath = path.join(issuesDir, filename);
            
            const frontmatter = yaml.dump({ title: issueTitle, labels, assignees });
            const content = `---\n${frontmatter.trim()}\n---\n\n${issueBody}\n`;
            
            fs.writeFileSync(filepath, content);
            execSync(`git add "${filepath}"`);
            execSync(`git commit -m "Add doc for issue #${issueNumber} [skip ci]"`);
            execSync('git push');
            console.log(`Created doc: ${filename}`);
          } else if (eventType === 'edited' && existingFiles.length > 0) {
            // Update existing doc
            const filepath = path.join(issuesDir, existingFiles[0]);
            
            const frontmatter = yaml.dump({ title: issueTitle, labels, assignees });
            const content = `---\n${frontmatter.trim()}\n---\n\n${issueBody}\n`;
            
            fs.writeFileSync(filepath, content);
            execSync(`git add "${filepath}"`);
            execSync(`git commit -m "Update doc for issue #${issueNumber} [skip ci]"`);
            execSync('git push');
            console.log(`Updated doc: ${existingFiles[0]}`);
          }
          SCRIPT

      - name: Sync issues (push event)
        if: github.event_name == 'push'
        uses: ./.github/actions/persist-github-issues-to-files
        with:
          mode: 'sync-issues'
          github-token: ${{ github.token }}
          repository: ${{ github.repository }}
          event-type: 'push'
          changed-files: ${{ steps.changed-files.outputs.files }}

      - name: Summary
        run: |
          {
            echo "✅ Issues synced successfully"
            echo ""
            echo "See [Issues](https://github.com/$GITHUB_REPOSITORY/issues)"
          } >> $GITHUB_STEP_SUMMARY
